<?php
if ( !defined( 'ABSPATH' ) ) { exit; } // Exit if accessed directly.

function zume_coaching_checklist_items() : array {
    return [
        1 => [
            'label' => _x( "God Uses Ordinary People", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "You'll see how God uses ordinary people doing simple things to make a big impact.",
            'url' => 'https://zume.training/god-uses-ordinary-people/',
            'type' => 'concept'
        ],
        2 => [
            'label' => _x( "Definition of Disciple & Church", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Discover the essence of being a disciple, making a disciple, and what is the church.",
            'url' => 'https://zume.training/definition-of-disciple-and-church/',
            'type' => 'concept'
        ],
        3 => [
            'label' => _x( "Breathing: Hearing & Obeying", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Being a disciple means we hear from God and we obey God.",
            'url' => 'https://zume.training/spiritual-breathing-is-hearing-and-obeying-god/',
            'type' => 'concept'
        ],
        4 => [
            'label' => _x( "SOAPS Bible Reading", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "A tool for daily Bible study that helps you understand, obey, and share God’s Word.",
            'url' => 'https://zume.training/soaps-bible-reading/',
            'type' => 'tool'
        ],
        5 => [
            'label' => _x( "Accountability Groups", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "A tool for two or three people of the same gender to meet weekly and encourage each other in areas that are going well and reveal areas that need correction.",
            'url' => 'https://zume.training/accountability-groups/',
            'type' => 'tool'
        ],
        6 => [
            'label' => _x( "Consumer vs Producer Lifestyle", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "You'll discover the four main ways God makes everyday followers more like Jesus.",
            'url' => 'https://zume.training/consumer-vs-producer-lifestyle/',
            'type' => 'concept'
        ],
        7 => [
            'label' => _x( "Prayer Wheel (Hour in Prayer)", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "See how easy it is to spend an hour in prayer.",
            'url' => 'https://zume.training/how-to-spend-an-hour-in-prayer/',
            'type' => 'tool'
        ],
        8 => [
            'label' => _x( "Relational Stewardship (List 100)", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "A tool designed to help you be a good steward of your relationships.",
            'url' => 'https://zume.training/relational-stewardship-list-of-100/',
            'type' => 'tool'
        ],
        9 => [
            'label' => _x( "Kingdom Economy", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn how God's economy is different from the world's. God invests more in those who are faithful with what they've already been given.",
            'url' => 'https://zume.training/the-kingdom-economy/',
            'type' => 'concept'
        ],
        10 => [
            'label' => _x( "How to Share the Gospel", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn a way to share God’s Good News from the beginning of humanity all the way to the end of this age.",
            'url' => 'https://zume.training/the-gospel-and-how-to-share-it/',
            'type' => 'tool'
        ],
        11 => [
            'label' => _x( "How to Baptize", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Jesus said, “Go and make disciples of all nations, BAPTIZING them in the name of the Father and of the Son and of the Holy Spirit…” Learn how to put this into practice.",
            'url' => 'https://zume.training/baptism-and-how-to-do-it/',
            'type' => 'tool'
        ],
        12 => [
            'label' => _x( "3 Minute Testimony", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn how to share your testimony in three minutes by sharing how Jesus has impacted your life.",
            'url' => 'https://zume.training/prepare-your-3-minute-testimony/',
            'type' => 'tool'
        ],
        13 => [
            'label' => _x( "Greatest Blessing", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn a simple pattern of making not just one follower of Jesus but entire spiritual families who multiply for generations to come.",
            'url' => 'https://zume.training/vision-casting-the-greatest-blessing/',
            'type' => 'tool'
        ],
        14 => [
            'label' => _x( "Duckling Discipleship", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn what ducklings have to do with disciple-making.",
            'url' => 'https://zume.training/duckling-discipleship-leading-sooner/',
            'type' => 'concept'
        ],
        15 => [
            'label' => _x( "See Where the Kingdom Isn't", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Begin to see where God’s Kingdom isn’t. These are usually the places where God wants to work the most.",
            'url' => 'https://zume.training/eyes-to-see-where-the-kingdom-isnt/',
            'type' => 'concept'
        ],
        16 => [
            'label' => _x( "Lord's Supper", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "It’s a simple way to celebrate our intimate connection and ongoing relationship with Jesus. Learn a simple way to celebrate.",
            'url' => 'https://zume.training/the-lords-supper-and-how-to-lead-it/',
            'type' => 'tool'
        ],
        17 => [
            'label' => _x( "Prayer Walking", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "It’s a simple way to obey God’s command to pray for others. And it's just what it sounds like — praying to God while walking around!",
            'url' => 'https://zume.training/prayer-walking/',
            'type' => 'tool'
        ],
        18 => [
            'label' => _x( "Person of Peace", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn who a person of peace might be and how to know when you've found one.",
            'url' => 'https://zume.training/a-person-of-peace-and-how-to-find-one/',
            'type' => 'concept'
        ],
        19 => [
            'label' => _x( "BLESS Prayer Pattern", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Practice a simple mnemonic to remind you of ways to pray for others.",
            'url' => 'https://zume.training/the-bless-prayer-pattern/',
            'type' => 'tool'
        ],
        20 => [
            'label' => _x( "Faithfulness is Better", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "It's important what disciples know — but it's much more important what they DO with what they know.",
            'url' => 'https://zume.training/faithfulness-is-better-than-knowledge/',
            'type' => 'concept'
        ],
        21 => [
            'label' => _x( "3/3 Group Format", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "A 3/3 Group is a way for followers of Jesus to meet, pray, learn, grow, fellowship and practice obeying and sharing what they've learned. In this way, a 3/3 Group is not just a small group but a Simple Church.",
            'url' => 'https://zume.training/3-3-group-meeting-pattern/',
            'type' => 'tool'
        ],
        22 => [
            'label' => _x( "Training Cycle", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn the training cycle and consider how it applies to disciple making.",
            'url' => 'https://zume.training/training-cycle-for-maturing-disciples/',
            'type' => 'concept'
        ],
        23 => [
            'label' => _x( "Leadership Cells", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "A Leadership Cell is a way someone who feels called to lead can develop their leadership by practicing serving.",
            'url' => 'https://zume.training/leadership-cells/',
            'type' => 'concept'
        ],
        24 => [
            'label' => _x( "Non-Sequential Growth", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "See how disciple making doesn't have to be linear. Multiple things can happen at the same time.",
            'url' => 'https://zume.training/expect-non-sequential-growth/',
            'type' => 'concept'
        ],
        25 => [
            'label' => _x( "Pace Matters", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Multiplying matters and multiplying quickly matters even more.",
            'url' => 'https://zume.training/pace-of-multiplication-matters/',
            'type' => 'concept'
        ],
        26 => [
            'label' => _x( "Being Part of Two Churches", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn how to obey Jesus' commands by going AND staying.",
            'url' => 'https://zume.training/always-part-of-two-churches/',
            'type' => 'concept'
        ],
        27 => [
            'label' => _x( "Coaching Checklist", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "A powerful tool you can use to quickly assess your own strengths and vulnerabilities when it comes to making disciples who multiply.",
            'url' => 'https://zume.training/coaching-checklist/',
            'type' => 'tool'
        ],
        28 => [
            'label' => _x( "Leadership in Networks", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Learn how multiplying churches stay connected and live life together as an extended, spiritual family.",
            'url' => 'https://zume.training/leadership-in-networks/',
            'type' => 'concept'
        ],
        29 => [
            'label' => _x( "Peer Mentoring Group", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "This is a group that consists of people who are leading and starting 3/3 Groups. It also follows a 3/3 format and is a powerful way to assess the spiritual health of God’s work in your area.",
            'url' => 'https://zume.training/peer-mentoring-groups/',
            'type' => 'concept'
        ],
        30 => [
            'label' => _x( "Four Fields Tool", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "The four fields diagnostic chart is a simple tool to be used by a leadership cell to reflect on the status of current efforts and the kingdom activity around them.",
            'url' => 'https://zume.training/four-fields-tool/',
            'type' => 'tool'
        ],
        31 => [
            'label' => _x( "Generational Mapping", "coaching checklist", 'zume-coaching-checklist' ),
            'description' => "Generation mapping is another simple tool to help leaders in a movement understand the growth around them.",
            'url' => 'https://zume.training/generational-mapping/',
            'type' => 'tool'
        ],
    ];
}

function zume_coaching_checklist_options() : array {
    return [
        "h" => [ "label" => _x( "H", "Coaching Checklist Initial for: Heard", 'zume-coaching-checklist' ) ],
        "o" => [ "label" => _x( "O", "Coaching Checklist Initial for: Obeying", 'zume-coaching-checklist' ) ],
        "s" => [ "label" => _x( "S", "Coaching Checklist Initial for: Sharing", 'zume-coaching-checklist' ) ],
        "t" => [ "label" => _x( "T", "Coaching Checklist Initial for: Training", 'zume-coaching-checklist' ) ],
    ];
}

function zume_write_checklist_row( $post, $post_fields, $field_key, $field_options, $item ) {
    $url = $item['url'] ?? 'https://zume.training/training';
    $post_fields[$field_key]["hidden"] = false;
    $post_fields[$field_key]["custom_display"] = false;

    ?>
    <div style="display: flex">
        <div style="flex-grow: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis">
            <a data-value="<?php echo esc_url( $url ); ?>" class="coaching-checklist-modal-open" target="_blank"><?php echo esc_html( $field_options["name"] ); ?></a>
        </div>
        <div style="white-space:nowrap;">
            <div class="small button-group" style="display: inline-block; margin-bottom: 5px;">
                <?php foreach ( $post_fields[$field_key]["default"] as $option_key => $option_value ): ?>
                    <?php
                    $class = ( in_array( $option_key, $post[$field_key] ?? [] ) ) ?
                        "selected-select-button" : "empty-select-button";
                    $ost = ( 'h' !== $option_key && "empty-select-button" === $class ) ? 'ost_button' : '';
                    ?>
                    <button id="<?php echo esc_html( $option_key ) ?>" type="button"
                            data-field-key="<?php echo esc_html( $field_key ); ?>"
                            data-option-key="<?php echo esc_html( $option_key ) ?>"
                            class="dt_multi_select <?php echo esc_html( $class ) ?> <?php echo esc_html( $field_key ); ?>_<?php echo esc_html( $option_key ) ?> select-button button <?php echo esc_html( $ost ) ?>" style="padding:5px">
                        <?php echo esc_html( $post_fields[$field_key]["default"][$option_key]["label"] ) ?>
                    </button>
                <?php endforeach; ?>
            </div>
        </div>
    </div>
    <?php
}

class Zume_Coaching_Checklist_Tile
{
    public $page_title = 'Zúme Coaching Checklist';
    public $page_description = 'Zúme Coaching Checklist for Zúme Training.';
    public $root = "zume_app";
    public $type = 'coaching_checklist';
    public $post_type = 'contacts';
    private $meta_key = 'zume_app_coaching_checklist_magic_key';

    private static $_instance = null;
    public static function instance(){
        if ( is_null( self::$_instance ) ) {
            self::$_instance = new self();
        }
        return self::$_instance;
    } // End instance()

    public function __construct(){
        add_filter( 'dt_details_additional_tiles', [ $this, "dt_details_additional_tiles" ], 10, 2 );
        add_action( "dt_details_additional_section", [ $this, "dt_details_additional_section" ], 30, 2 );
        add_filter( 'dt_settings_apps_list', [ $this, 'dt_settings_apps_list' ], 10, 1 );
        add_filter( "dt_custom_fields_settings", [ $this, "dt_custom_fields_settings" ], 10, 2 );

    }

    /**
     * This function registers a new tile to a specific post type
     *
     * @param $tiles
     * @param string $post_type
     * @return mixed
     */
    public function dt_details_additional_tiles( $tiles, $post_type = "" ) {
        if ( $post_type === 'contacts' && ! isset( $tiles["apps"] ) ){
            $tiles["apps"] = [
                "label" => __( "Apps", 'disciple_tools' ),
                "description" => __( "Apps available on this record.", 'disciple_tools' )
            ];
        }
        return $tiles;
    }

    /**
     * @param array $fields
     * @param string $post_type
     * @return array
     */
    public function dt_custom_fields_settings( array $fields, string $post_type = "" ) {
        if ( $post_type === "contacts" ){

            $options = zume_coaching_checklist_options();

            $zume_coaching_checklist_items = zume_coaching_checklist_items();

            foreach ( $zume_coaching_checklist_items as $item_key => $item ){
                $fields["zume_coaching_checklist_" . $item_key ] = [
                    "name" => $item['label'],
                    "description" => $item['description'],
                    "default" => $options,
                    "tile" => "zume_coaching_checklist",
                    "type" => "multi_select",
                    "hidden" => true,
                    "custom_display" => true,
                ];
            }
        }
        return $fields;
    }

    public function dt_details_additional_section( $section, $post_type ) {

        if ( $section === "apps" && $post_type === "contacts" ) {
            $record = DT_Posts::get_post( $post_type, get_the_ID() );
            if ( isset( $record[$this->meta_key] )) {
                $key = $record[$this->meta_key];
            } else {
                $key = dt_create_unique_key();
                update_post_meta( get_the_ID(), $this->meta_key, $key );
            }
            $link = DT_Magic_URL::get_link_url( $this->root, $this->type, $key )
            ?>
            <div class="section-subheader"><?php echo esc_html( $this->page_title ) ?></div>
            <div class="section-app-links <?php echo esc_attr( $this->meta_key ); ?>">
                <a type="button" class="empty-select-button select-button small button view"><img class="dt-icon" src="<?php echo get_template_directory_uri() . '/dt-assets/images/visibility.svg' ?>" /></a>
                <a type="button" class="empty-select-button select-button small button copy_to_clipboard" data-value="<?php echo esc_html( $link ); ?>"><img class="dt-icon" src="<?php echo get_template_directory_uri() . '/dt-assets/images/duplicate.svg' ?>" /></a>
                <a type="button" class="empty-select-button select-button small button send"><img class="dt-icon" src="<?php echo get_template_directory_uri() . '/dt-assets/images/send.svg' ?>" /></a>
                <a type="button" class="empty-select-button select-button small button qr"><img class="dt-icon" src="<?php echo get_template_directory_uri() . '/dt-assets/images/qrcode-solid.svg' ?>" /></a>
                <a type="button" class="empty-select-button select-button small button reset"><img class="dt-icon" src="<?php echo get_template_directory_uri() . '/dt-assets/images/undo.svg' ?>" /></a>
            </div>
            <script>
                jQuery(document).ready(function(){
                    if ( typeof window.app_key === 'undefined' ){
                        window.app_key = []
                    }
                    if ( typeof window.app_url === 'undefined' ){
                        window.app_url = []
                    }
                    window.app_key['<?php echo esc_attr( $this->meta_key ) ?>'] = '<?php echo esc_attr( $key ) ?>'
                    window.app_url['<?php echo esc_attr( $this->meta_key ) ?>'] = '<?php echo esc_url( site_url() . '/' . $this->root . '/' .$this->type . '/' ) ?>'

                    jQuery('.<?php echo esc_attr( $this->meta_key ); ?>.select-button.button.copy_to_clipboard').data('value', `${window.app_url['<?php echo esc_attr( $this->meta_key ) ?>']}${window.app_key['<?php echo esc_attr( $this->meta_key ) ?>']}`)
                    jQuery('.section-app-links.<?php echo esc_attr( $this->meta_key ); ?> .view').on('click', function(e){
                        jQuery('#modal-large-title').empty().html(`<h3 class="section-header"><?php echo esc_html( $this->page_title )  ?></h3><span class="small-text"><?php echo esc_html( $this->page_description ) ?></span><hr>`)
                        jQuery('#modal-large-content').empty().html(`<iframe src="${window.app_url['<?php echo esc_attr( $this->meta_key ) ?>']}${window.app_key['<?php echo esc_attr( $this->meta_key ) ?>']}" style="width:100%;height: ${window.innerHeight - 170}px;border:1px solid lightgrey;"></iframe>`)
                        jQuery('#modal-large').foundation('open')
                    })
                    jQuery('.section-app-links.<?php echo esc_attr( $this->meta_key ); ?> .send').on('click', function(e){
                        jQuery('#modal-small-title').empty().html(`<h3 class="section-header"><?php echo esc_html( $this->page_title )  ?></h3><span class="small-text">Send a link via email through the system.</span><hr>`)
                        jQuery('#modal-small-content').empty().html(`<div class="grid-x"><div class="cell"><input type="text" class="note <?php echo esc_attr( $this->meta_key ); ?>" placeholder="Add a note" /><br><button type="button" class="button <?php echo esc_attr( $this->meta_key ); ?>">Send Email with Link</button></div></div>`)
                        jQuery('#modal-small').foundation('open')
                        jQuery('.button.<?php echo esc_attr( $this->meta_key ); ?>').on('click', function(e){
                            let note = jQuery('.note.<?php echo esc_attr( $this->meta_key ); ?>').val()
                            makeRequest('POST', window.detailsSettings.post_type + '/email_magic', { root: '<?php echo esc_attr( $this->root ); ?>', type: '<?php echo esc_attr( $this->type ); ?>', magic_key: '<?php echo esc_attr( $this->meta_key ); ?>', note: note, post_ids: [ window.detailsSettings.post_id ] } )
                                .done( data => {
                                    jQuery('#modal-small').foundation('close')
                                })
                        })
                    })
                    jQuery('.section-app-links.<?php echo esc_attr( $this->meta_key ); ?> .qr').on('click', function(e){
                        jQuery('#modal-small-title').empty().html(`<h3 class="section-header"><?php echo esc_html( $this->page_title )  ?></h3><span class="small-text">QR codes are useful for passing the coaching links to mobile devices.</span><hr>`)
                        jQuery('#modal-small-content').empty().html(`<div class="grid-x"><div class="cell center"><img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${window.app_url['<?php echo esc_attr( $this->meta_key ) ?>']}${window.app_key['<?php echo esc_attr( $this->meta_key ) ?>']}" style="max-width:400px;" /></div></div>`)
                        jQuery('#modal-small').foundation('open')
                    })
                    jQuery('.section-app-links.<?php echo esc_attr( $this->meta_key ); ?> .reset').on('click', function(e){
                        jQuery('#modal-small-title').empty().html(`<h3 class="section-header"><?php echo esc_html( $this->page_title )  ?></h3><span class="small-text">Reset the security code. No data is removed. Only access. The previous link will be disabled and another one created.</span><hr>`)
                        jQuery('#modal-small-content').empty().html(`<button type="button" class="button <?php echo esc_attr( $this->meta_key ); ?> delete-and-reset">Delete and replace the app link</button> <span class="loading-spinner"></span>`)
                        jQuery('#modal-small').foundation('open')
                        jQuery('.button.<?php echo esc_attr( $this->meta_key ); ?>.delete-and-reset').on('click', function(e){
                            jQuery('.button.<?php echo esc_attr($this->meta_key); ?>.delete-and-reset').prop('disable', true)
                            window.API.update_post('<?php echo esc_attr( $post_type ); ?>', <?php echo esc_attr( get_the_ID()); ?>, { ['<?php echo esc_attr( $this->meta_key ); ?>']: window.sha256(Date.now()) })
                                .done( newPost => {
                                    console.log( newPost )
                                    jQuery('#modal-small').foundation('close')
                                    window.app_key['<?php echo esc_attr( $this->meta_key ) ?>'] = newPost['<?php echo esc_attr( $this->meta_key ) ?>']
                                    jQuery('.section-app-links.<?php echo esc_attr( $this->meta_key ); ?> .select-button.button.copy_to_clipboard').data('value', `${window.app_url['<?php echo esc_attr( $this->meta_key ) ?>']}${window.app_key['<?php echo esc_attr( $this->meta_key ) ?>']}`)
                                })
                        })
                    })
                })
            </script>
            <?php
        }
    }

    public function dt_settings_apps_list( $apps_list ) {
        $apps_list[$this->meta_key] = [
            'key' => $this->meta_key,
            'url_base' => $this->root. '/'. $this->type,
            'label' => $this->page_title,
            'description' => $this->page_description,
        ];
        return $apps_list;
    }

}
Zume_Coaching_Checklist_Tile::instance();
